<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏£‡∏á‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Prompt', sans-serif;
    }
    
    .gradient-bg {
      background: linear-gradient(135deg, #dc2626 0%, #f59e0b 50%, #fbbf24 100%);
    }
    
    .card-shadow {
      box-shadow: 0 10px 40px rgba(220, 38, 38, 0.15);
    }
    
    .tab-active {
      background: linear-gradient(135deg, #dc2626, #ea580c);
      color: white;
      box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
    }
    
    .chart-container {
      position: relative;
      height: 280px;
    }
    
    .loading-spinner {
      border: 4px solid #fef3c7;
      border-top: 4px solid #dc2626;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 50px rgba(220, 38, 38, 0.25);
    }
    
    .pulse-dot {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #fef3c7;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #dc2626, #f59e0b);
      border-radius: 4px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gradient-to-br from-amber-50 via-orange-50 to-red-50">
  <div id="app" class="h-full overflow-auto"><!-- Header -->
   <header class="gradient-bg text-white py-6 px-4 shadow-2xl">
    <div class="max-w-7xl mx-auto flex items-center gap-4"><img src="https://img2.pic.in.th/logob0b7643db577ceee.png" alt="Logo" class="w-16 h-16 rounded-full bg-white p-1 shadow-lg" onerror="this.style.background='linear-gradient(135deg, #fbbf24, #f59e0b)'; this.alt='üè´';">
     <div>
      <h1 id="app-title" class="text-2xl md:text-3xl font-bold drop-shadow-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <p id="school-name" class="text-amber-100 text-sm md:text-base font-light">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞</p>
     </div>
     <div class="ml-auto hidden md:flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">
      <div class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div><span class="text-sm">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
     </div>
    </div>
   </header><!-- Tab Navigation -->
   <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex flex-wrap gap-3 mb-6"><button id="tab-year" onclick="switchTab('year')" class="tab-active px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ </button> <button id="tab-topic" onclick="switchTab('topic')" class="bg-white text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:bg-amber-100 flex items-center gap-2 shadow-md">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ </button>
    </div><!-- Year Tab Content -->
    <div id="year-content" class="fade-in"><!-- Year Selector -->
     <div class="bg-white rounded-2xl p-6 mb-6 card-shadow">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-gradient-to-r from-red-500 to-amber-500 rounded-lg flex items-center justify-center text-white">üìÖ</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <div id="year-buttons" class="flex flex-wrap gap-3"><!-- Year buttons will be inserted here -->
      </div>
     </div><!-- Loading State -->
     <div id="loading-year" class="hidden flex flex-col items-center justify-center py-20">
      <div class="loading-spinner mb-4"></div>
      <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
     </div><!-- Charts Grid -->
     <div id="charts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"><!-- Charts will be inserted here -->
     </div>
    </div><!-- Topic Tab Content -->
    <div id="topic-content" class="hidden fade-in"><!-- Topic Selector -->
     <div class="bg-white rounded-2xl p-6 mb-6 card-shadow">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-gradient-to-r from-red-500 to-amber-500 rounded-lg flex items-center justify-center text-white">üìä</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h3>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"><button onclick="selectTopic('‡∏ä‡∏±‡πâ‡∏ô')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üéì ‡∏ä‡∏±‡πâ‡∏ô </button> <button onclick="selectTopic('‡πÄ‡∏û‡∏®')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üë§ ‡πÄ‡∏û‡∏® </button> <button onclick="selectTopic('‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üåç ‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥ </button> <button onclick="selectTopic('‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üß¨ ‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥ </button> <button onclick="selectTopic('‡∏®‡∏≤‡∏™‡∏ô‡∏≤')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üôè ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ </button> <button onclick="selectTopic('‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üíë ‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™ </button> <button onclick="selectTopic('‡∏ï‡∏≥‡∏ö‡∏•')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üìç ‡∏ï‡∏≥‡∏ö‡∏• </button> <button onclick="selectTopic('‡∏≠‡∏≥‡πÄ‡∏†‡∏≠')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üèòÔ∏è ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ </button> <button onclick="selectTopic('‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î')" class="topic-btn bg-gradient-to-r from-amber-50 to-orange-50 hover:from-red-100 hover:to-amber-100 text-gray-700 px-4 py-3 rounded-xl font-medium transition-all duration-300 border-2 border-transparent hover:border-red-300"> üó∫Ô∏è ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î </button>
      </div>
     </div><!-- Loading State -->
     <div id="loading-topic" class="hidden flex flex-col items-center justify-center py-20">
      <div class="loading-spinner mb-4"></div>
      <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
     </div><!-- Comparison Chart -->
     <div id="comparison-chart-container" class="hidden bg-white rounded-2xl p-6 card-shadow">
      <h3 id="comparison-title" class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2"><span class="w-10 h-10 bg-gradient-to-r from-red-500 to-amber-500 rounded-xl flex items-center justify-center text-white text-lg">üìà</span> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <div class="h-96">
       <canvas id="comparison-chart"></canvas>
      </div>
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="gradient-bg text-white py-4 px-4 mt-8">
    <div class="max-w-7xl mx-auto text-center">
     <p class="text-amber-100 text-sm">¬© 2567 ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞ | ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
    </div>
   </footer>
  </div>
  <script>
    // Configuration
    const API_URL = 'https://script.google.com/macros/s/AKfycbwcrGA_CapQ2P5W7I9q33PAm0mQkwaQbGoNcRQHuAzRGChjIB_2IMP5ew70y4UV1mK0/exec';
    const SHEET_NAMES = ['2566', '2567', '2568'];
    const COLUMNS = ['‡∏ä‡∏±‡πâ‡∏ô', '‡πÄ‡∏û‡∏®', '‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥', '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤', '‡∏ï‡∏≥‡∏ö‡∏•', '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'];
    const COLUMN_ICONS = {
      '‡∏ä‡∏±‡πâ‡∏ô': 'üéì',
      '‡πÄ‡∏û‡∏®': 'üë§',
      '‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥': 'üåç',
      '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥': 'üß¨',
      '‡∏®‡∏≤‡∏™‡∏ô‡∏≤': 'üôè',
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤': 'üíë',
      '‡∏ï‡∏≥‡∏ö‡∏•': 'üìç',
      '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠': 'üèòÔ∏è',
      '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î': 'üó∫Ô∏è'
    };

    // Color palette
    const CHART_COLORS = [
      '#dc2626', '#f59e0b', '#fbbf24', '#ea580c', '#ef4444',
      '#f97316', '#facc15', '#fb923c', '#fcd34d', '#fdba74',
      '#b91c1c', '#d97706', '#ca8a04', '#c2410c', '#991b1b'
    ];

    // State
    let currentYear = null;
    let currentTopic = null;
    let allData = {};
    let charts = {};
    let comparisonChart = null;

    // Default config
    const defaultConfig = {
      school_name: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞',
      app_title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      primary_color: '#dc2626',
      secondary_color: '#f59e0b',
      text_color: '#1f2937',
      background_color: '#fffbeb',
      surface_color: '#ffffff'
    };

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (config) => {
          document.getElementById('school-name').textContent = config.school_name || defaultConfig.school_name;
          document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
        },
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => window.elementSdk.setConfig({ background_color: value })
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => window.elementSdk.setConfig({ surface_color: value })
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => window.elementSdk.setConfig({ text_color: value })
            },
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => window.elementSdk.setConfig({ primary_color: value })
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => window.elementSdk.setConfig({ secondary_color: value })
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['school_name', config.school_name || defaultConfig.school_name],
          ['app_title', config.app_title || defaultConfig.app_title]
        ])
      });
    }

    // Fetch data from Google Apps Script
    async function fetchSheetData(sheetName) {
      try {
        const response = await fetch(`${API_URL}?sheet=${encodeURIComponent(sheetName)}`);
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        return data;
      } catch (error) {
        console.error(`Error fetching data for ${sheetName}:`, error);
        return [];
      }
    }

    // Count occurrences
    function countOccurrences(data, column) {
      const counts = {};
      data.forEach(row => {
        const value = row[column] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        counts[value] = (counts[value] || 0) + 1;
      });
      return counts;
    }

    // Create chart
    function createChart(containerId, title, data, icon) {
      const container = document.getElementById('charts-grid');
      const chartId = `chart-${containerId}`;
      
      const total = Object.values(data).reduce((a, b) => a + b, 0);
      
      const cardHtml = `
        <div class="bg-white rounded-2xl p-5 card-shadow stat-card transition-all duration-300 fade-in" style="animation-delay: ${Object.keys(charts).length * 0.1}s">
          <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-gradient-to-r from-red-500 to-amber-500 rounded-lg flex items-center justify-center text-white">${icon}</span>
            ${title}
            <span class="ml-auto text-sm font-normal text-gray-500">‡∏£‡∏ß‡∏° ${total} ‡∏Ñ‡∏ô</span>
          </h4>
          <div class="chart-container">
            <canvas id="${chartId}"></canvas>
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', cardHtml);
      
      const ctx = document.getElementById(chartId).getContext('2d');
      const labels = Object.keys(data);
      const values = Object.values(data);
      
      if (charts[chartId]) {
        charts[chartId].destroy();
      }
      
      charts[chartId] = new Chart(ctx, {
        type: labels.length > 5 ? 'bar' : 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: CHART_COLORS.slice(0, labels.length),
            borderWidth: labels.length > 5 ? 0 : 3,
            borderColor: '#ffffff',
            borderRadius: labels.length > 5 ? 8 : 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: labels.length > 5 ? 'top' : 'right',
              labels: {
                font: { family: 'Prompt', size: 11 },
                padding: 10,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw;
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value} ‡∏Ñ‡∏ô (${percentage}%)`;
                }
              },
              backgroundColor: 'rgba(220, 38, 38, 0.9)',
              titleFont: { family: 'Prompt', size: 14 },
              bodyFont: { family: 'Prompt', size: 13 },
              padding: 12,
              cornerRadius: 10
            }
          },
          scales: labels.length > 5 ? {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { family: 'Prompt' } }
            },
            x: {
              grid: { display: false },
              ticks: { 
                font: { family: 'Prompt', size: 10 },
                maxRotation: 45,
                minRotation: 45
              }
            }
          } : {}
        }
      });
    }

    // Load year data
    async function loadYearData(year) {
      currentYear = year;
      
      // Update button styles
      document.querySelectorAll('#year-buttons button').forEach(btn => {
        btn.classList.remove('bg-gradient-to-r', 'from-red-500', 'to-amber-500', 'text-white', 'shadow-lg');
        btn.classList.add('bg-amber-100', 'text-gray-700');
      });
      
      const activeBtn = document.querySelector(`#year-buttons button[data-year="${year}"]`);
      if (activeBtn) {
        activeBtn.classList.remove('bg-amber-100', 'text-gray-700');
        activeBtn.classList.add('bg-gradient-to-r', 'from-red-500', 'to-amber-500', 'text-white', 'shadow-lg');
      }
      
      // Show loading
      document.getElementById('loading-year').classList.remove('hidden');
      document.getElementById('charts-grid').innerHTML = '';
      
      // Destroy existing charts
      Object.values(charts).forEach(chart => chart.destroy());
      charts = {};
      
      // Fetch data if not cached
      if (!allData[year]) {
        allData[year] = await fetchSheetData(year);
      }
      
      const data = allData[year];
      
      // Hide loading
      document.getElementById('loading-year').classList.add('hidden');
      
      if (data.length === 0) {
        document.getElementById('charts-grid').innerHTML = `
          <div class="col-span-full text-center py-10 text-gray-500">
            <div class="text-6xl mb-4">üì≠</div>
            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ${year}</p>
          </div>
        `;
        return;
      }
      
      // Create charts for each column
      COLUMNS.forEach(column => {
        const counts = countOccurrences(data, column);
        createChart(column.replace(/[^a-zA-Z0-9‡∏Å-‡πô]/g, ''), column, counts, COLUMN_ICONS[column]);
      });
    }

    // Select topic for comparison
    async function selectTopic(topic) {
      currentTopic = topic;
      
      // Update button styles
      document.querySelectorAll('.topic-btn').forEach(btn => {
        btn.classList.remove('ring-2', 'ring-red-500', 'bg-red-100');
      });
      
      event.target.closest('button').classList.add('ring-2', 'ring-red-500', 'bg-red-100');
      
      // Show loading
      document.getElementById('loading-topic').classList.remove('hidden');
      document.getElementById('comparison-chart-container').classList.add('hidden');
      
      // Fetch all years data
      for (const year of SHEET_NAMES) {
        if (!allData[year]) {
          allData[year] = await fetchSheetData(year);
        }
      }
      
      // Hide loading
      document.getElementById('loading-topic').classList.add('hidden');
      document.getElementById('comparison-chart-container').classList.remove('hidden');
      
      // Update title
      document.getElementById('comparison-title').innerHTML = `
        <span class="w-10 h-10 bg-gradient-to-r from-red-500 to-amber-500 rounded-xl flex items-center justify-center text-white text-lg">${COLUMN_ICONS[topic]}</span>
        ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö${topic}‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏µ
      `;
      
      // Prepare comparison data
      const allLabels = new Set();
      SHEET_NAMES.forEach(year => {
        const counts = countOccurrences(allData[year] || [], topic);
        Object.keys(counts).forEach(label => allLabels.add(label));
      });
      
      const labels = Array.from(allLabels);
      const datasets = SHEET_NAMES.map((year, index) => {
        const counts = countOccurrences(allData[year] || [], topic);
        return {
          label: `‡∏õ‡∏µ ${year}`,
          data: labels.map(label => counts[label] || 0),
          backgroundColor: CHART_COLORS[index * 3],
          borderColor: CHART_COLORS[index * 3],
          borderWidth: 2,
          borderRadius: 8
        };
      });
      
      // Create comparison chart
      const ctx = document.getElementById('comparison-chart').getContext('2d');
      
      if (comparisonChart) {
        comparisonChart.destroy();
      }
      
      comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: { family: 'Prompt', size: 13, weight: '500' },
                padding: 20,
                usePointStyle: true,
                pointStyle: 'circle'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const year = context.dataset.label;
                  const value = context.raw;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${year}: ${value} ‡∏Ñ‡∏ô (${percentage}%)`;
                }
              },
              backgroundColor: 'rgba(220, 38, 38, 0.9)',
              titleFont: { family: 'Prompt', size: 14 },
              bodyFont: { family: 'Prompt', size: 13 },
              padding: 12,
              cornerRadius: 10
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' },
              ticks: { font: { family: 'Prompt' } }
            },
            x: {
              grid: { display: false },
              ticks: { 
                font: { family: 'Prompt', size: 11 },
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    // Switch tabs
    function switchTab(tab) {
      const yearTab = document.getElementById('tab-year');
      const topicTab = document.getElementById('tab-topic');
      const yearContent = document.getElementById('year-content');
      const topicContent = document.getElementById('topic-content');
      
      if (tab === 'year') {
        yearTab.className = 'tab-active px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2';
        topicTab.className = 'bg-white text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:bg-amber-100 flex items-center gap-2 shadow-md';
        yearContent.classList.remove('hidden');
        topicContent.classList.add('hidden');
      } else {
        topicTab.className = 'tab-active px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2';
        yearTab.className = 'bg-white text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:bg-amber-100 flex items-center gap-2 shadow-md';
        topicContent.classList.remove('hidden');
        yearContent.classList.add('hidden');
      }
    }

    // Initialize
    async function init() {
      // Create year buttons
      const yearButtonsContainer = document.getElementById('year-buttons');
      SHEET_NAMES.forEach(year => {
        const btn = document.createElement('button');
        btn.dataset.year = year;
        btn.className = 'bg-amber-100 text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:bg-gradient-to-r hover:from-red-500 hover:to-amber-500 hover:text-white flex items-center gap-2 shadow-md';
        btn.innerHTML = `
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          ‡∏õ‡∏µ ${year}
        `;
        btn.onclick = () => loadYearData(year);
        yearButtonsContainer.appendChild(btn);
      });
      
      // Load first year by default
      if (SHEET_NAMES.length > 0) {
        loadYearData(SHEET_NAMES[0]);
      }
    }

    // Start app
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c7a6575c6aa819e',t:'MTc3MDA0MjczMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
