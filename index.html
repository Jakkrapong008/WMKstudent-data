<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body { box-sizing: border-box; font-family: 'Prompt', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #f59e0b 50%, #fbbf24 100%); }
    .card-shadow { box-shadow: 0 10px 40px rgba(220, 38, 38, 0.15); }
    .tab-active { background: linear-gradient(135deg, #dc2626, #ea580c); color: white; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4); }
    .chart-container { position: relative; height: 280px; }
    .loading-spinner { border: 4px solid #fef3c7; border-top: 4px solid #dc2626; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 50px rgba(220, 38, 38, 0.25); }
    .pulse-dot { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #fef3c7; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #dc2626, #f59e0b); border-radius: 4px; }
  </style>
 </head>
 <body class="h-full bg-gradient-to-br from-amber-50 via-orange-50 to-red-50">
  <div id="app" class="h-full overflow-auto">
   
   <!-- Header -->
   <header class="gradient-bg text-white py-6 px-4 shadow-2xl">
    <div class="max-w-7xl mx-auto flex items-center gap-4">
     <img src="https://img2.pic.in.th/logob0b7643db577ceee.png" alt="Logo" class="w-16 h-16 rounded-full bg-white p-1 shadow-lg" onerror="this.src='https://via.placeholder.com/64?text=WMK';">
     <div>
      <h1 class="text-2xl md:text-3xl font-bold drop-shadow-lg">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
      <p class="text-2xl md:text-3xl font-bold drop-shadow-lg">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞</p>
     </div>
     <div id="connection-status" class="ml-auto hidden md:flex items-center gap-2 bg-white/20 px-4 py-2 rounded-full backdrop-blur-sm">
      <div id="status-dot" class="w-2 h-2 bg-green-400 rounded-full pulse-dot"></div>
      <span id="status-text" class="text-sm">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß</span>
     </div>
    </div>
   </header>

   <!-- Error Alert (Hidden by default) -->
   <div id="error-alert" class="max-w-7xl mx-auto px-4 mt-4 hidden">
     <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg flex items-start gap-3 shadow-md">
       <div class="text-red-500">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
       </div>
       <div>
         <p class="text-red-800 font-bold text-sm">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</p>
         <p id="error-message" class="text-red-700 text-xs">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Deploy ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</p>
       </div>
       <button onclick="window.location.reload()" class="ml-auto bg-red-100 hover:bg-red-200 text-red-700 px-3 py-1 rounded text-xs font-medium transition-colors">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
     </div>
   </div>

   <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex flex-wrap gap-3 mb-6">
     <button id="tab-year" onclick="switchTab('year')" class="tab-active px-6 py-3 rounded-xl font-medium transition-all duration-300 flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ 
     </button> 
     <button id="tab-topic" onclick="switchTab('topic')" class="bg-white text-gray-700 px-6 py-3 rounded-xl font-medium transition-all duration-300 hover:bg-amber-100 flex items-center gap-2 shadow-md">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 
     </button>
    </div>

    <!-- Year View -->
    <div id="year-content" class="fade-in">
     <div class="bg-white rounded-2xl p-6 mb-6 card-shadow">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-gradient-to-r from-red-500 to-amber-500 rounded-lg flex items-center justify-center text-white">üìÖ</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <div id="year-buttons" class="flex flex-wrap gap-3">
        <p id="year-loading-msg" class="text-gray-400 text-sm animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
      </div>
     </div>

     <div id="loading-year" class="hidden flex flex-col items-center justify-center py-20">
      <div class="loading-spinner mb-4"></div>
      <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®...</p>
     </div>
     <div id="charts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Topic View -->
    <div id="topic-content" class="hidden fade-in">
     <div class="bg-white rounded-2xl p-6 mb-6 card-shadow">
      <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2"><span class="w-8 h-8 bg-gradient-to-r from-red-500 to-amber-500 rounded-lg flex items-center justify-center text-white">üìä</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h3>
      <div id="topic-buttons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
     </div>
     <div id="loading-topic" class="hidden flex flex-col items-center justify-center py-20">
      <div class="loading-spinner mb-4"></div>
      <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö...</p>
     </div>
     <div id="comparison-chart-container" class="hidden bg-white rounded-2xl p-6 card-shadow">
      <h3 id="comparison-title" class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2"></h3>
      <div class="h-96">
       <canvas id="comparison-chart"></canvas>
      </div>
     </div>
    </div>
   </div>

   <footer class="gradient-bg text-white py-4 px-4 mt-8">
    <div class="max-w-7xl mx-auto text-center">
     <p class="text-amber-100 text-sm">¬© ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÅ‡∏°‡πà‡∏Å‡∏∞</p>
    </div>
   </footer>
  </div>

  <script>
    // URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Apps Script
    const API_URL = 'https://script.google.com/macros/s/AKfycbwcrGA_CapQ2P5W7I9q33PAm0mQkwaQbGoNcRQHuAzRGChjIB_2IMP5ew70y4UV1mK0/exec';
    
    const COLUMNS = ['‡∏ä‡∏±‡πâ‡∏ô', '‡πÄ‡∏û‡∏®', '‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥', '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤', '‡∏ï‡∏≥‡∏ö‡∏•', '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'];
    const COLUMN_ICONS = {
      '‡∏ä‡∏±‡πâ‡∏ô': 'üéì', '‡πÄ‡∏û‡∏®': 'üë§', '‡∏™‡∏±‡∏ç‡∏ä‡∏≤‡∏ï‡∏¥': 'üåç', '‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏ä‡∏≤‡∏ï‡∏¥': 'üß¨', '‡∏®‡∏≤‡∏™‡∏ô‡∏≤': 'üôè',
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏£‡∏™‡∏Ç‡∏≠‡∏á‡∏ö‡∏¥‡∏î‡∏≤‡∏°‡∏≤‡∏£‡∏î‡∏≤': 'üíë', '‡∏ï‡∏≥‡∏ö‡∏•': 'üìç', '‡∏≠‡∏≥‡πÄ‡∏†‡∏≠': 'üèòÔ∏è', '‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î': 'üó∫Ô∏è'
    };

    const CHART_COLORS = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#26C6DA', '#66BB6A', '#FFA726', '#AB47BC', '#EF5350', '#5C6BC0', '#26A69A', '#D4E157', '#FFEE58'];

    let SHEET_NAMES = []; 
    let allData = {};
    let charts = {};
    let comparisonChart = null;

    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    function showError(msg) {
      document.getElementById('error-alert').classList.remove('hidden');
      document.getElementById('error-message').innerText = msg;
      
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      if(statusDot) {
        statusDot.classList.replace('bg-green-400', 'bg-red-500');
        statusText.innerText = '‡∏Ç‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error
    async function fetchAvailableYears() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s timeout
        
        const response = await fetch(`${API_URL}?action=getSheets`, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const years = await response.json();
        
        return Array.isArray(years) 
          ? years.filter(y => /^\d{4}$/.test(y)).sort((a, b) => parseInt(a) - parseInt(b))
          : [];
      } catch (error) {
        console.warn('Cannot fetch years dynamically, using fallback:', error);
        if (error.name === 'AbortError') showError('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ');
        else showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ (Failed to fetch)');
        return ['2566', '2567', '2568']; 
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏µ‡∏ó ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error
    async function fetchSheetData(sheetName) {
      try {
        const response = await fetch(`${API_URL}?sheet=${encodeURIComponent(sheetName)}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return Array.isArray(data) ? data.filter(row => Object.values(row).some(v => v !== '')) : [];
      } catch (error) {
        console.error(`Fetch Error for ${sheetName}:`, error);
        showError(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ ${sheetName} ‡πÑ‡∏î‡πâ`);
        return [];
      }
    }

    function getValue(row, key) {
      if (!row) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
      const actualKey = Object.keys(row).find(k => k.trim() === key.trim());
      const val = actualKey ? row[actualKey] : null;
      return (val === null || val === undefined || val === '') ? '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' : String(val).trim();
    }

    function countOccurrences(data, column) {
      const counts = {};
      data.forEach(row => {
        const val = getValue(row, column);
        counts[val] = (counts[val] || 0) + 1;
      });
      return counts;
    }

    function createChart(columnName, title, data, icon) {
      const container = document.getElementById('charts-grid');
      const chartId = `chart-${columnName.replace(/\s+/g, '-')}`;
      const total = Object.values(data).reduce((a, b) => a + b, 0);
      
      const cardHtml = `
        <div class="bg-white rounded-2xl p-5 card-shadow stat-card transition-all duration-300 fade-in">
          <h4 class="text-base font-semibold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 bg-gradient-to-r from-red-500 to-amber-500 rounded-lg flex items-center justify-center text-white text-xs">${icon}</span>
            <span class="truncate">${title}</span>
            <span class="ml-auto text-xs font-normal text-gray-500 shrink-0">‡∏£‡∏ß‡∏° ${total}</span>
          </h4>
          <div class="chart-container"><canvas id="${chartId}"></canvas></div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', cardHtml);
      
      const ctx = document.getElementById(chartId).getContext('2d');
      const labels = Object.keys(data);
      const values = Object.values(data);
      const isBar = labels.length > 5;

      charts[chartId] = new Chart(ctx, {
        type: isBar ? 'bar' : 'doughnut',
        data: {
          labels,
          datasets: [{ 
            data: values, 
            backgroundColor: CHART_COLORS.slice(0, labels.length), 
            borderWidth: isBar ? 0 : 2, 
            borderColor: '#fff', 
            borderRadius: isBar ? 8 : 0 
          }]
        },
        options: {
          responsive: true, 
          maintainAspectRatio: false,
          plugins: {
            legend: { display: !isBar, position: 'right', labels: { font: { family: 'Prompt', size: 10 }, usePointStyle: true } },
            tooltip: { 
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleFont: { family: 'Prompt' },
              bodyFont: { family: 'Prompt' },
              callbacks: { label: (ctx) => `${ctx.label}: ${ctx.raw} ‡∏Ñ‡∏ô (${((ctx.raw/total)*100).toFixed(1)}%)` } 
            }
          },
          scales: isBar ? { y: { beginAtZero: true }, x: { ticks: { font: { size: 9, family: 'Prompt' } } } } : {}
        }
      });
    }

    async function loadYearData(year) {
      if (!year) return;
      
      document.querySelectorAll('#year-buttons button').forEach(btn => {
        btn.classList.remove('tab-active');
        btn.classList.add('bg-white', 'text-gray-700');
      });
      const activeBtn = document.querySelector(`button[data-year="${year}"]`);
      if (activeBtn) { activeBtn.classList.add('tab-active'); activeBtn.classList.remove('bg-white', 'text-gray-700'); }

      document.getElementById('loading-year').classList.remove('hidden');
      document.getElementById('charts-grid').innerHTML = '';
      Object.values(charts).forEach(c => c.destroy());
      charts = {};

      if (!allData[year]) allData[year] = await fetchSheetData(year);
      document.getElementById('loading-year').classList.add('hidden');

      if (!allData[year] || !allData[year].length) {
        document.getElementById('charts-grid').innerHTML = `<p class="col-span-full text-center py-10 text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ ${year} ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>`;
        return;
      }
      COLUMNS.forEach(col => createChart(col, col, countOccurrences(allData[year], col), COLUMN_ICONS[col]));
    }

    async function selectTopic(topic, element) {
      document.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('ring-2', 'ring-red-500', 'bg-red-50'));
      element.classList.add('ring-2', 'ring-red-500', 'bg-red-50');
      document.getElementById('loading-topic').classList.remove('hidden');
      document.getElementById('comparison-chart-container').classList.add('hidden');

      for (const y of SHEET_NAMES) { if (!allData[y]) allData[y] = await fetchSheetData(y); }

      document.getElementById('loading-topic').classList.add('hidden');
      document.getElementById('comparison-chart-container').classList.remove('hidden');
      document.getElementById('comparison-title').innerHTML = `<span class="w-10 h-10 bg-gradient-to-r from-red-500 to-amber-500 rounded-xl flex items-center justify-center text-white">${COLUMN_ICONS[topic]}</span> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö: ${topic}`;

      const allLabels = new Set();
      SHEET_NAMES.forEach(y => {
        if (allData[y]) Object.keys(countOccurrences(allData[y], topic)).forEach(l => allLabels.add(l));
      });
      const labels = Array.from(allLabels);

      const datasets = SHEET_NAMES.map((y, i) => ({
        label: `‡∏õ‡∏µ ${y}`,
        data: labels.map(l => (allData[y] ? countOccurrences(allData[y], topic)[l] : 0) || 0),
        backgroundColor: CHART_COLORS[i % CHART_COLORS.length],
        borderRadius: 5
      }));

      if (comparisonChart) comparisonChart.destroy();
      comparisonChart = new Chart(document.getElementById('comparison-chart'), {
        type: 'bar', data: { labels, datasets },
        options: { 
          responsive: true, 
          maintainAspectRatio: false, 
          plugins: { 
            legend: { position: 'top', labels: { font: { family: 'Prompt' } } },
            tooltip: { titleFont: { family: 'Prompt' }, bodyFont: { family: 'Prompt' } }
          } 
        }
      });
    }

    function switchTab(tab) {
      const isYear = tab === 'year';
      document.getElementById('tab-year').className = isYear ? 'tab-active px-6 py-3 rounded-xl font-medium flex items-center gap-2' : 'bg-white text-gray-700 px-6 py-3 rounded-xl font-medium shadow-md flex items-center gap-2';
      document.getElementById('tab-topic').className = !isYear ? 'tab-active px-6 py-3 rounded-xl font-medium flex items-center gap-2' : 'bg-white text-gray-700 px-6 py-3 rounded-xl font-medium shadow-md flex items-center gap-2';
      document.getElementById('year-content').classList.toggle('hidden', !isYear);
      document.getElementById('topic-content').classList.toggle('hidden', isYear);
    }

    async function init() {
      // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
      SHEET_NAMES = await fetchAvailableYears();
      
      const yearContainer = document.getElementById('year-buttons');
      yearContainer.innerHTML = '';
      
      if (!SHEET_NAMES || SHEET_NAMES.length === 0) {
        yearContainer.innerHTML = '<p class="text-red-500 text-sm">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>';
        return;
      }

      SHEET_NAMES.forEach(y => {
        const btn = document.createElement('button');
        btn.dataset.year = y;
        btn.className = 'bg-white text-gray-700 px-6 py-3 rounded-xl font-medium transition-all shadow-md hover:bg-amber-50 border border-amber-100';
        btn.innerHTML = `‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${y}`;
        btn.onclick = () => loadYearData(y);
        yearContainer.appendChild(btn);
      });

      const topicContainer = document.getElementById('topic-buttons');
      COLUMNS.forEach(topic => {
        const btn = document.createElement('button');
        btn.className = 'topic-btn bg-white text-gray-700 px-4 py-3 rounded-xl font-medium transition-all shadow-sm border border-amber-100 hover:bg-amber-50 flex items-center gap-2';
        btn.innerHTML = `<span>${COLUMN_ICONS[topic]}</span> <span class="truncate">${topic}</span>`;
        btn.onclick = (e) => selectTopic(topic, e.currentTarget);
        topicContainer.appendChild(btn);
      });

      // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏µ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      if (SHEET_NAMES.length > 0) {
        loadYearData(SHEET_NAMES[SHEET_NAMES.length - 1]);
      }
    }

    window.onload = init;
  </script>
 </body>
</html>
